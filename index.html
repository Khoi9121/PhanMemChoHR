<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Pro + Telegram Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .modal-base {
            transition: all 0.3s ease;
            visibility: hidden; opacity: 0; pointer-events: none;
        }
        .modal-base.visible-custom {
            visibility: visible; opacity: 1; pointer-events: auto;
        }
        .modal-box {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: scale(0.95) translateY(20px);
        }
        .modal-base.visible-custom .modal-box {
            transform: scale(1) translateY(0);
        }

        .fc { --fc-border-color: #f1f5f9; --fc-button-bg-color: #6366f1; --fc-button-border-color: #6366f1; }
        .fc-event { padding: 4px 10px; border-radius: 8px; font-weight: 600; border: none !important; font-size: 0.75rem; }
        
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body class="bg-[#f8fafc] min-h-screen text-slate-800 pb-12">

    <div class="max-w-6xl mx-auto px-6 pt-10">
        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-end mb-10 gap-6">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-200">
                        <i class="fas fa-paper-plane text-xl"></i>
                    </div>
                    <h1 class="text-3xl font-extrabold tracking-tight text-slate-900">HR <span class="text-indigo-600">Telegram Pro</span></h1>
                </div>
                <p class="text-slate-500 font-medium">Qu·∫£n l√Ω ·ª©ng vi√™n & Th√¥ng b√°o qua @TroLyChiChauHR_bot</p>
            </div>
            <div class="flex gap-3">
                <button onclick="openConfigModal()" class="bg-white hover:bg-slate-50 text-slate-600 font-bold py-3.5 px-5 rounded-2xl transition-all shadow-sm border border-slate-200 flex items-center group">
                    <i class="fas fa-cog mr-2 text-indigo-500"></i> C·∫•u h√¨nh Bot
                </button>
                <button onclick="openCalendarModal()" class="bg-white hover:bg-slate-50 text-slate-700 font-bold py-3.5 px-6 rounded-2xl transition-all shadow-sm border border-slate-200 flex items-center group">
                    <i class="fas fa-calendar-day mr-2 text-indigo-500"></i> Xem l·ªãch
                </button>
                <button onclick="openCandidateModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 px-8 rounded-2xl transition-all shadow-xl shadow-indigo-100 flex items-center group">
                    <i class="fas fa-plus mr-2"></i> Th√™m m·ªõi
                </button>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div id="stats" class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-10">
            <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                <p class="text-[9px] font-extrabold text-slate-400 uppercase tracking-widest mb-1">T·ªïng h·ªì s∆°</p>
                <p id="statTotal" class="text-xl font-black text-slate-800">0</p>
            </div>
            <div class="bg-indigo-50/50 p-5 rounded-3xl border border-indigo-100/50 shadow-sm">
                <p class="text-[9px] font-extrabold text-indigo-400 uppercase tracking-widest mb-1">ƒê√£ PV</p>
                <p id="statInterviewed" class="text-xl font-black text-indigo-600">0</p>
            </div>
            <div class="bg-emerald-50/50 p-5 rounded-3xl border border-emerald-100/50 shadow-sm">
                <p class="text-[9px] font-extrabold text-emerald-400 uppercase tracking-widest mb-1">Ph√π h·ª£p</p>
                <p id="statQualified" class="text-xl font-black text-emerald-600">0</p>
            </div>
            <div class="bg-amber-50/50 p-5 rounded-3xl border border-amber-100/50 shadow-sm">
                <p class="text-[9px] font-extrabold text-amber-400 uppercase tracking-widest mb-1">ƒêang x√©t</p>
                <p id="statPending" class="text-xl font-black text-amber-600">0</p>
            </div>
            <div class="bg-rose-50/50 p-5 rounded-3xl border border-rose-100/50 shadow-sm">
                <p class="text-[9px] font-extrabold text-rose-400 uppercase tracking-widest mb-1">Lo·∫°i</p>
                <p id="statRejected" class="text-xl font-black text-rose-600">0</p>
            </div>
            <div class="bg-slate-900 p-5 rounded-3xl shadow-sm">
                <p class="text-[9px] font-extrabold text-slate-400 uppercase tracking-widest mb-1">Chat ID</p>
                <p id="statChatId" class="text-[10px] font-black text-white truncate">Ch∆∞a c√†i ƒë·∫∑t</p>
            </div>
        </div>

        <!-- Filters -->
        <div class="flex flex-col md:flex-row gap-4 mb-6">
            <div class="flex-1 glass-card p-2 rounded-2xl border border-slate-200 shadow-sm flex items-center gap-2">
                <div class="flex items-center pl-3 text-slate-400"><i class="fas fa-search"></i></div>
                <input type="text" id="filterPosition" onkeyup="filterData()" placeholder="L·ªçc theo v·ªã tr√≠ ·ª©ng tuy·ªÉn..." class="w-full bg-transparent border-none outline-none py-2 text-sm font-semibold text-slate-700">
                <button onclick="resetFilters()" class="px-4 py-2 text-xs font-black text-indigo-600 hover:bg-indigo-50 rounded-xl transition-colors uppercase">ƒê·∫∑t l·∫°i</button>
            </div>
        </div>

        <!-- List Table -->
        <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden">
            <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/30">
                <h2 class="text-lg font-extrabold text-slate-800 flex items-center">
                    Danh s√°ch ·ª©ng vi√™n
                    <span id="resultCount" class="ml-3 px-2 py-0.5 bg-slate-200 text-slate-500 text-[10px] rounded-md font-bold italic">...</span>
                </h2>
                <button onclick="fetchCandidates()" class="p-2 text-slate-400 hover:text-indigo-600 transition-colors"><i class="fas fa-sync-alt"></i></button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50/50">
                            <th class="px-8 py-5 text-[11px] font-black text-slate-400 uppercase tracking-widest">H·ªç t√™n & V·ªã tr√≠</th>
                            <th class="px-8 py-5 text-[11px] font-black text-slate-400 uppercase tracking-widest text-center">Ng√†y PV</th>
                            <th class="px-8 py-5 text-[11px] font-black text-slate-400 uppercase tracking-widest text-center">Tr·∫°ng th√°i</th>
                            <th class="px-8 py-5 text-[11px] font-black text-slate-400 uppercase tracking-widest text-center">B√°o Bot</th>
                            <th class="px-8 py-5 text-[11px] font-black text-slate-400 uppercase tracking-widest text-right">Chi ti·∫øt</th>
                        </tr>
                    </thead>
                    <tbody id="candidateTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD CANDIDATE -->
    <div id="candidateModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-base">
        <div onclick="closeModal('candidateModal')" class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"></div>
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-lg relative z-10 modal-box overflow-hidden">
            <div class="px-10 pt-10 pb-6 flex justify-between items-center">
                <h3 class="text-2xl font-black text-slate-900">H·ªì s∆° m·ªõi</h3>
                <button onclick="closeModal('candidateModal')" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200"><i class="fas fa-times"></i></button>
            </div>
            <form id="candidateForm" class="px-10 pb-10 space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-2">H·ªç t√™n</label><input type="text" name="ho_ten" required placeholder="Nguy·ªÖn VƒÉn A" class="w-full px-5 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-indigo-500 font-semibold"></div>
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-2">V·ªã tr√≠</label><input type="text" name="vi_tri" required placeholder="VD: K·∫ø to√°n" class="w-full px-5 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-indigo-500 font-semibold"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-2">Email</label><input type="email" name="email" required placeholder="name@company.com" class="w-full px-5 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-indigo-500 font-semibold"></div>
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-2">SƒêT</label><input type="tel" name="sdt" required placeholder="090..." class="w-full px-5 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-indigo-500 font-semibold"></div>
                </div>
                <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-2">Ng√†y ph·ªèng v·∫•n</label><input type="date" id="dateInput" name="ngay_phong_van" required class="w-full px-5 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-indigo-500 font-bold text-slate-600"></div>
                <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-2">Nh·∫≠n x√©t ban ƒë·∫ßu</label><textarea name="ghi_chu" rows="2" placeholder="Ghi ch√∫ v·ªÅ ·ª©ng vi√™n..." class="w-full px-5 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-indigo-500 font-semibold"></textarea></div>
                
                <div class="flex items-center gap-2 px-2">
                    <input type="checkbox" id="sendTgNew" checked class="w-4 h-4 accent-indigo-600 rounded">
                    <label for="sendTgNew" class="text-xs font-bold text-slate-500">B√°o qua @TroLyChiChauHR_bot ngay</label>
                </div>

                <button type="submit" id="btnSubmit" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-indigo-700 transition-all uppercase tracking-wider">L∆∞u h·ªì s∆°</button>
            </form>
        </div>
    </div>

    <!-- MODAL: DETAIL & UPDATE -->
    <div id="detailModal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 modal-base">
        <div onclick="closeModal('detailModal')" class="absolute inset-0 bg-slate-900/60 backdrop-blur-md"></div>
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-lg relative z-10 modal-box overflow-hidden">
            <div id="detailContent" class="p-10 space-y-6"></div>
            <div class="px-10 pb-6 flex items-center gap-2">
                <input type="checkbox" id="sendTgUpdate" checked class="w-4 h-4 accent-indigo-600 rounded">
                <label for="sendTgUpdate" class="text-xs font-bold text-slate-400">G·ª≠i th√¥ng b√°o c·∫≠p nh·∫≠t qua Telegram</label>
            </div>
            <div class="p-8 bg-slate-50 border-t border-slate-100 flex gap-4">
                <button onclick="confirmDelete()" id="btnDelete" class="w-12 h-12 flex items-center justify-center bg-rose-50 text-rose-500 hover:bg-rose-500 hover:text-white rounded-2xl transition-all border border-rose-100"><i class="fas fa-trash-alt"></i></button>
                <button onclick="closeModal('detailModal')" class="flex-1 py-4 font-bold text-slate-400 hover:text-slate-600 text-sm">ƒê√ìNG</button>
                <button onclick="updateCandidate()" id="btnUpdate" class="flex-[3] bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-indigo-700 text-sm tracking-wide uppercase">C·∫≠p nh·∫≠t & B√°o Bot</button>
            </div>
        </div>
    </div>

    <!-- CALENDAR MODAL -->
    <div id="calendarModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-base">
        <div onclick="closeModal('calendarModal')" class="absolute inset-0 bg-slate-900/70 backdrop-blur-lg"></div>
        <div class="bg-white rounded-[3rem] shadow-2xl w-full max-w-5xl h-[85vh] relative z-10 modal-box overflow-hidden flex flex-col">
            <div class="p-8 border-b border-slate-50 flex justify-between items-center"><h3 class="text-2xl font-black text-slate-900">L·ªãch tr√¨nh</h3><button onclick="closeModal('calendarModal')" class="w-12 h-12 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100"><i class="fas fa-times"></i></button></div>
            <div class="flex-1 p-8 overflow-y-auto" id="calendar"></div>
        </div>
    </div>

    <!-- CONFIG TELEGRAM MODAL -->
    <div id="configModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-base">
        <div onclick="closeModal('configModal')" class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm"></div>
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-md relative z-10 modal-box p-10">
            <h3 class="text-2xl font-black text-slate-900 mb-2">C·∫•u h√¨nh Bot</h3>
            <p class="text-xs text-slate-500 mb-6">Nh·∫≠p Chat ID t·ª´ <b>@userinfobot</b> ƒë·ªÉ nh·∫≠n th√¥ng b√°o.</p>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Chat ID</label>
                    <input type="text" id="tgChatId" placeholder="VD: 123456789" class="w-full px-5 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-indigo-500 font-mono text-sm">
                </div>
                <button onclick="saveConfig()" class="w-full bg-slate-900 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-black transition-all uppercase tracking-wider">L∆∞u Chat ID</button>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 translate-y-32 opacity-0 transition-all duration-500 bg-slate-900 text-white px-8 py-4 rounded-full z-[100] flex items-center shadow-2xl">
        <div id="toastIconBox" class="w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center mr-3"><i class="fas fa-check text-[10px]" id="toastIcon"></i></div>
        <span id="toastMsg" class="font-bold text-sm">Th√†nh c√¥ng</span>
    </div>

    <script>
        const SHEETDB_URL = 'https://sheetdb.io/api/v1/54rgcr47hqclf';
        const BOT_TOKEN = '8572972435:AAHKhFG2rSLKbIGwuGHfcYoUbNlJ81h5r7c';
        
        let allData = [];
        let displayData = [];
        let currentEmail = null;
        let fcCalendar = null;
        let config = { token: BOT_TOKEN, chatId: localStorage.getItem('tgChatId') || '' };

        const getStatusTheme = (s) => {
            switch(s) {
                case 'Ph√π h·ª£p': return { bg: 'bg-emerald-50', text: 'text-emerald-600', border: 'border-emerald-100', dot: 'bg-emerald-500', hex: '#10b981' };
                case 'Kh√¥ng ph√π h·ª£p': return { bg: 'bg-rose-50', text: 'text-rose-600', border: 'border-rose-100', dot: 'bg-rose-500', hex: '#f43f5e' };
                case 'ƒê√£ ph·ªèng v·∫•n': return { bg: 'bg-indigo-50', text: 'text-indigo-600', border: 'border-indigo-100', dot: 'bg-indigo-500', hex: '#6366f1' };
                case 'ƒêang xem x√©t': return { bg: 'bg-amber-50', text: 'text-amber-600', border: 'border-amber-100', dot: 'bg-amber-500', hex: '#f59e0b' };
                default: return { bg: 'bg-slate-50', text: 'text-slate-500', border: 'border-slate-100', dot: 'bg-slate-400', hex: '#94a3b8' };
            }
        };

        async function fetchCandidates() {
            const body = document.getElementById('candidateTableBody');
            body.innerHTML = `<tr><td colspan="5" class="py-24 text-center"><div class="flex flex-col items-center"><div class="loader mb-4"></div><p class="text-slate-400 italic font-medium">ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu...</p></div></td></tr>`;
            try {
                const res = await fetch(SHEETDB_URL);
                allData = await res.json();
                filterData();
            } catch (err) {
                showToast("L·ªói k·∫øt n·ªëi API!", "error");
            }
        }

        function filterData() {
            const pos = document.getElementById('filterPosition').value.toLowerCase();
            displayData = allData.filter(c => {
                const cPos = (c.vi_tri || '').toLowerCase();
                return !pos || cPos.includes(pos);
            });
            renderUI();
        }

        function renderUI() {
            const body = document.getElementById('candidateTableBody');
            if (displayData.length === 0) {
                body.innerHTML = `<tr><td colspan="5" class="py-20 text-center text-slate-400 italic">Kh√¥ng t√¨m th·∫•y ·ª©ng vi√™n</td></tr>`;
                updateDashboard(0,0,0,0,0);
                return;
            }
            body.innerHTML = displayData.sort((a,b) => new Date(b.ngay_phong_van) - new Date(a.ngay_phong_van)).map(c => {
                const theme = getStatusTheme(c.trang_thai);
                return `<tr class="hover:bg-slate-50 transition cursor-pointer group">
                    <td class="px-8 py-5" onclick="openDetailModal('${c.email}')">
                        <div class="font-bold text-slate-900">${c.ho_ten}</div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="bg-indigo-600 text-white text-[9px] px-2 py-0.5 rounded-md font-black uppercase">${c.vi_tri || 'N/A'}</span>
                            <span class="text-xs text-slate-400 font-medium">${c.email}</span>
                        </div>
                    </td>
                    <td class="px-8 py-5 text-center font-bold text-slate-500 text-sm" onclick="openDetailModal('${c.email}')">${c.ngay_phong_van}</td>
                    <td class="px-8 py-5 text-center" onclick="openDetailModal('${c.email}')"><span class="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-xl border text-[10px] font-black uppercase tracking-wider ${theme.bg} ${theme.text} ${theme.border}"><span class="w-1.5 h-1.5 rounded-full ${theme.dot}"></span>${c.trang_thai || 'M·ªõi'}</span></td>
                    <td class="px-8 py-5 text-center">
                        <button onclick="sendToTelegramManual('${c.email}')" class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 hover:bg-indigo-600 hover:text-white transition-all flex items-center justify-center mx-auto"><i class="fab fa-telegram-plane"></i></button>
                    </td>
                    <td class="px-8 py-5 text-right"><button onclick="openDetailModal('${c.email}')" class="w-10 h-10 rounded-xl bg-slate-50 text-slate-300 group-hover:bg-indigo-600 group-hover:text-white transition-all flex items-center justify-center ml-auto"><i class="fas fa-chevron-right text-xs"></i></button></td>
                </tr>`;
            }).join('');

            updateDashboard(
                allData.length,
                allData.filter(d => d.trang_thai === 'ƒê√£ ph·ªèng v·∫•n').length,
                allData.filter(d => d.trang_thai === 'Ph√π h·ª£p').length,
                allData.filter(d => d.trang_thai === 'ƒêang xem x√©t').length,
                allData.filter(d => d.trang_thai === 'Kh√¥ng ph√π h·ª£p').length
            );
            document.getElementById('resultCount').innerText = `${displayData.length} ·ª©ng vi√™n`;
            if (fcCalendar) refreshCalendar();
        }

        function updateDashboard(t, i, q, p, r) {
            document.getElementById('statTotal').innerText = t;
            document.getElementById('statInterviewed').innerText = i;
            document.getElementById('statQualified').innerText = q;
            document.getElementById('statPending').innerText = p;
            document.getElementById('statRejected').innerText = r;
            document.getElementById('statChatId').innerText = config.chatId || "Ch∆∞a thi·∫øt l·∫≠p";
        }

        async function sendTelegram(message) {
            if (!config.chatId) { showToast("Vui l√≤ng c√†i Chat ID tr∆∞·ªõc!", "error"); return false; }
            try {
                const response = await fetch(`https://api.telegram.org/bot${config.token}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: config.chatId, text: message, parse_mode: 'HTML' })
                });
                return response.ok;
            } catch (e) { return false; }
        }

        async function sendToTelegramManual(email) {
            const c = allData.find(x => x.email === email);
            if (!c) return;
            const msg = `üîî <b>TH√îNG TIN ·ª®NG VI√äN</b>\n\nüë§ <b>T√™n:</b> ${c.ho_ten}\nüíº <b>V·ªã tr√≠:</b> ${c.vi_tri}\nüìÖ <b>Ng√†y PV:</b> ${c.ngay_phong_van}\nüìå <b>Tr·∫°ng th√°i:</b> ${c.trang_thai}\nüìù <b>Ghi ch√∫:</b> ${c.ghi_chu || 'Kh√¥ng c√≥'}`;
            const ok = await sendTelegram(msg);
            if (ok) showToast("ƒê√£ g·ª≠i b√°o c√°o Telegram!");
        }

        document.getElementById('candidateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            btn.disabled = true; btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ƒêang l∆∞u...`;
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.trang_thai = "Ch∆∞a ph·ªèng v·∫•n";

            try {
                await fetch(SHEETDB_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: [data] })
                });

                if (document.getElementById('sendTgNew').checked) {
                    const msg = `üöÄ <b>·ª®NG VI√äN M·ªöI</b>\n\nüë§ <b>T√™n:</b> ${data.ho_ten}\nüéØ <b>V·ªã tr√≠:</b> ${data.vi_tri}\nüìÖ <b>L·ªãch PV:</b> ${data.ngay_phong_van}`;
                    await sendTelegram(msg);
                }

                showToast('Th√™m h·ªì s∆° th√†nh c√¥ng!');
                closeModal('candidateModal');
                e.target.reset();
                fetchCandidates();
            } catch (err) { showToast('L·ªói g·ª≠i d·ªØ li·ªáu!', 'error'); } 
            finally { btn.disabled = false; btn.innerText = 'L∆∞u h·ªì s∆°'; }
        });

        function openDetailModal(email) {
            const c = allData.find(x => x.email === email);
            if (!c) return;
            currentEmail = email;
            const theme = getStatusTheme(c.trang_thai);
            document.getElementById('detailModal').classList.add('visible-custom');
            document.getElementById('detailContent').innerHTML = `
                <div class="flex items-center gap-6">
                    <div class="w-16 h-16 rounded-3xl flex items-center justify-center text-white text-2xl font-black shadow-lg" style="background: ${theme.hex}">${c.ho_ten.charAt(0)}</div>
                    <div>
                        <h2 class="text-2xl font-black text-slate-900">${c.ho_ten}</h2>
                        <span class="bg-slate-100 text-slate-500 px-3 py-1 rounded-lg text-[10px] font-black uppercase tracking-widest mt-1 inline-block">${c.vi_tri || 'N/A'}</span>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100"><p class="text-[9px] font-black text-slate-400 uppercase mb-1">Email</p><p class="font-bold text-slate-700 text-xs truncate">${c.email}</p></div>
                    <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100"><p class="text-[9px] font-black text-slate-400 uppercase mb-1">SƒêT</p><p class="font-bold text-slate-700 text-xs">${c.sdt}</p></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-2">Ng√†y PV</label><input type="date" id="upDate" value="${c.ngay_phong_van}" class="w-full px-5 py-3.5 bg-white border border-slate-200 rounded-2xl font-bold text-slate-600 outline-none"></div>
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-2">Tr·∫°ng th√°i</label><select id="upStatus" class="w-full px-5 py-3.5 bg-white border border-slate-200 rounded-2xl font-bold text-slate-700 outline-none"><option value="Ch∆∞a ph·ªèng v·∫•n" ${c.trang_thai === 'Ch∆∞a ph·ªèng v·∫•n' ? 'selected' : ''}>Ch∆∞a PV</option><option value="ƒê√£ ph·ªèng v·∫•n" ${c.trang_thai === 'ƒê√£ ph·ªèng v·∫•n' ? 'selected' : ''}>ƒê√£ PV</option><option value="Ph√π h·ª£p" ${c.trang_thai === 'Ph√π h·ª£p' ? 'selected' : ''}>Ph√π h·ª£p</option><option value="Kh√¥ng ph√π h·ª£p" ${c.trang_thai === 'Kh√¥ng ph√π h·ª£p' ? 'selected' : ''}>Lo·∫°i</option><option value="ƒêang xem x√©t" ${c.trang_thai === 'ƒêang xem x√©t' ? 'selected' : ''}>ƒêang x√©t</option></select></div>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Nh·∫≠n x√©t chi ti·∫øt</label>
                    <textarea id="upNote" rows="4" class="w-full px-6 py-4 bg-slate-50 border border-slate-100 rounded-3xl font-medium text-slate-600 outline-none" placeholder="Ghi ch√∫ sau ph·ªèng v·∫•n...">${c.ghi_chu || ''}</textarea>
                </div>
            `;
        }

        async function updateCandidate() {
            if (!currentEmail) return;
            const btn = document.getElementById('btnUpdate');
            btn.disabled = true; btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ƒêang l∆∞u...`;
            const data = {
                ngay_phong_van: document.getElementById('upDate').value,
                trang_thai: document.getElementById('upStatus').value,
                ghi_chu: document.getElementById('upNote').value
            };
            try {
                await fetch(`${SHEETDB_URL}/email/${encodeURIComponent(currentEmail)}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data })
                });

                if (document.getElementById('sendTgUpdate').checked) {
                    const msg = `üìù <b>C·∫¨P NH·∫¨T PH·ªéNG V·∫§N</b>\n\nüë§ <b>T√™n:</b> ${currentEmail}\nüìå <b>Tr·∫°ng th√°i m·ªõi:</b> ${data.trang_thai}\nüìù <b>Ghi ch√∫:</b> ${data.ghi_chu}`;
                    await sendTelegram(msg);
                }

                showToast('ƒê√£ c·∫≠p nh·∫≠t!');
                closeModal('detailModal');
                fetchCandidates();
            } catch (e) { showToast('L·ªói c·∫≠p nh·∫≠t!', 'error'); } 
            finally { btn.disabled = false; btn.innerText = 'C·∫¨P NH·∫¨T & B√ÅO BOT'; }
        }

        async function confirmDelete() {
            if (!currentEmail || !confirm(`X√≥a h·ªì s∆°: ${currentEmail}?`)) return;
            try {
                await fetch(`${SHEETDB_URL}/email/${encodeURIComponent(currentEmail)}`, { method: 'DELETE' });
                showToast('ƒê√£ x√≥a h·ªì s∆°!');
                closeModal('detailModal');
                fetchCandidates();
            } catch (e) { showToast('L·ªói!', 'error'); }
        }

        function openCalendarModal() {
            document.getElementById('calendarModal').classList.add('visible-custom');
            setTimeout(() => {
                if (!fcCalendar) {
                    fcCalendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                        initialView: 'dayGridMonth', locale: 'vi',
                        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
                        events: displayData.map(c => ({ title: c.ho_ten, start: c.ngay_phong_van, backgroundColor: getStatusTheme(c.trang_thai).hex, extendedProps: { email: c.email } })),
                        eventClick: (info) => openDetailModal(info.event.extendedProps.email)
                    });
                } else { refreshCalendar(); }
                fcCalendar.render();
            }, 300);
        }

        function refreshCalendar() {
            fcCalendar.removeAllEvents();
            fcCalendar.addEventSource(displayData.map(c => ({ title: c.ho_ten, start: c.ngay_phong_van, backgroundColor: getStatusTheme(c.trang_thai).hex, extendedProps: { email: c.email } })));
        }

        function openConfigModal() {
            document.getElementById('tgChatId').value = config.chatId;
            document.getElementById('configModal').classList.add('visible-custom');
        }

        function saveConfig() {
            const val = document.getElementById('tgChatId').value;
            if(!val) return showToast("Nh·∫≠p ID c·ªßa b·∫°n!", "error");
            localStorage.setItem('tgChatId', val);
            config.chatId = val;
            showToast("ƒê√£ l∆∞u c·∫•u h√¨nh Bot!");
            closeModal('configModal');
            renderUI();
        }

        function openCandidateModal() {
            document.getElementById('candidateModal').classList.add('visible-custom');
            document.getElementById('dateInput').valueAsDate = new Date();
        }

        function closeModal(id) { document.getElementById(id).classList.remove('visible-custom'); }

        function showToast(msg, type = 'success') {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            const box = document.getElementById('toastIconBox');
            if (type === 'error') { box.className = 'w-6 h-6 rounded-full bg-rose-500 flex items-center justify-center mr-3'; document.getElementById('toastIcon').className = 'fas fa-exclamation text-[10px]'; } 
            else { box.className = 'w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center mr-3'; document.getElementById('toastIcon').className = 'fas fa-check text-[10px]'; }
            t.classList.remove('translate-y-32', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-32', 'opacity-0'), 3000);
        }

        function resetFilters() { document.getElementById('filterPosition').value = ''; filterData(); }

        window.onload = fetchCandidates;
    </script>
</body>
</html>